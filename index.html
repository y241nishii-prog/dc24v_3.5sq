<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>V_Drop Checker[DC24V_3.5sq]</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #fafafa; }
  header { display: flex; align-items: center; margin-bottom: 10px; }
  header img { height: 50px; margin-right: 15px; }
  header h1 { font-size: 22px; margin: 0; }

  #conditions, #projectInfo {
    background: #eef5ff;
    padding: 10px 15px;
    margin-bottom: 20px;
    border-radius: 8px;
    border: 1px solid #cbd5e1;
  }

  input[type=text] { width: 200px; margin-left: 10px; }

  table { border-collapse: collapse; width: 100%; margin: 10px 0; background: #fff; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: left; font-size: 13px; }
  th { background: #eee; }
  .warning { color: red; font-weight: bold; }

  button { padding: 6px 10px; border: none; color: white; border-radius: 6px; cursor: pointer; margin: 4px; }
  .add-btn { background-color: #007bff; }
  .remove-btn { background-color: #dc3545; }
  .calc-btn { background-color: #198754; }
  .print-btn { background-color: #6c757d; }
  button:hover { opacity: 0.85; }

  @page { size: A4 portrait; margin: 15mm; }
  @media print {
    /* 操作要素を非表示 */
    button, header, #circuits, #conditions, #projectInfo { display: none !important; }
    
    /* 印刷ヘッダー: position: fixed を削除し、コンテンツが2ページ目以降も流れるようにする */
    #printHeader {
      display: block !important;
      top: 0; 
      left: 0; 
      width: 100%;
      background: white;
      border-bottom: 2px solid #ccc;
      padding: 5px 15px;
    }
    
    /* 1ページ目の計算結果タイトルにのみ上余白を設定し、ヘッダーとの重なりを解消 */
    #result h2:first-child { 
        margin-top: 130px;
    }
    
    /* 大きなブロックが途中で切れないように設定 */
    .circuit, .branch, table {
        page-break-inside: avoid;
    }
  }
  #printHeader { display: none; }
</style>
</head>
<body>

<header>
  <img src="miraria.png" alt="ロゴ">
  <h1>V_Drop Checker[DC24V_3.5sq]</h1>
</header>

<div id="projectInfo">
  <strong>■ 物件情報</strong><br>
  物件名：<input type="text" id="projectName" placeholder="例：○○邸 外構照明計画"><br>
  作成担当者：<input type="text" id="creator" placeholder="例：三協 太郎">
</div>

<div id="conditions">
  <strong>■ 条件設定</strong><br>
  トランス電圧：<b>DC24V</b>　
  電源コード：<b>9.5mmコード(3.5sq)</b>　
  電圧降下量：<b>0.00044 V/W･m</b>　　
  許容電圧降下：<b>2.0V</b><br>
  トランス容量：
  <select id="transformer">
    <option value="35">35W</option>
    <option value="75">75W</option>
  </select>
</div>

<div id="printHeader">
  <img src="三協アルミ_4C透過.png" alt="ロゴ" style="height:35px; vertical-align:middle; margin-right:10px;">
  <img src="miraria.png" alt="ロゴ" style="height:35px; vertical-align:middle; margin-right:10px;">
  <span style="font-size:18px; font-weight:bold;">V_Drop Checker[DC24V_1.25sq]</span><br>
  <small id="printConditions"></small><br>
  <small id="printProjectInfo"></small>
</div>

<div>
  <button class="add-btn" onclick="addCircuit()">＋ ライン追加</button>
</div>

<div id="circuits"></div>

<div>
  <button class="calc-btn" onclick="calc()">計算する</button>
  <button class="print-btn" onclick="preparePrint()">印刷（PDF保存可）</button>
</div>

<div id="result"></div>

<script>
  const DROP_PER_M = 0.00044;
  const MAX_CIRCUITS = 4;
  const MAX_BRANCHES = 4;
  const MAX_SUB_BRANCHES = 4; // サブ分岐の最大数
  const circuitsDiv = document.getElementById("circuits");

  // --- 1. ラインの追加/削除/更新 ---
  function addCircuit() {
    if (circuitsDiv.children.length >= MAX_CIRCUITS) {
      alert("最大4ラインまで追加できます。");
      return;
    }
    const wrapper = document.createElement("div");
    wrapper.className = "circuit";
    wrapper.innerHTML = `
      <h2>ライン ${circuitsDiv.children.length + 1}
        <button class="remove-btn" onclick="removeCircuit(this)">ライン削除</button>
      </h2>
      <p>トランス〜最上位分岐点までの長さ(m)：
        <input type="number" class="len-to-branch" min="0" step="0.1" value="0" style="width:70px;">
      </p>
      <div class="branches"></div>
      <button class="add-btn" onclick="addBranch(this)">＋ 分岐追加</button>
      <hr>
    `;
    circuitsDiv.appendChild(wrapper);
    updateCircuitNumbers();
  }

  function removeCircuit(btn) {
    btn.closest(".circuit").remove();
    updateCircuitNumbers();
  }

  function updateCircuitNumbers() {
    document.querySelectorAll(".circuit").forEach((c, idx) => {
      const h2 = c.querySelector("h2");
      h2.innerHTML = `ライン ${idx + 1}
        <button class='remove-btn' onclick='removeCircuit(this)'>ライン削除</button>`;
    });
  }

  // --- 2. 最上位分岐の追加/削除/更新 ---
  function addBranch(btn) {
    const branchesDiv = btn.parentNode.querySelector(".branches");
    const circuitIndex = Array.from(circuitsDiv.children).indexOf(btn.closest(".circuit")) + 1;

    if (branchesDiv.children.length >= MAX_BRANCHES) {
      alert("最上位の分岐は最大4つまでです。");
      return;
    }

    const branchWrapper = document.createElement("div");
    branchWrapper.className = "branch";
    branchWrapper.innerHTML = `
      <h3>分岐 ${circuitIndex}-${branchesDiv.children.length + 1}
        <button class="remove-btn" onclick="removeBranch(this)">分岐削除</button>
      </h3>
      <div class="branch-content" style="border: 1px dashed #007bff; padding: 10px; margin-top: 5px;">
          
          <h4 style="margin-top: 0px;">▼ 接続照明（分岐点から配線）</h4>
          <table>
            <thead>
              <tr><th>番号</th><th>名称・記号</th><th>消費電力(W)</th><th>コード長さ(m)</th><th>操作</th></tr>
            </thead>
            <tbody class="direct-lamps"></tbody>
          </table>
          <button class="add-btn" onclick="addLamp(this)">＋ 照明追加</button>

          <h4 style="margin-top: 15px;">▼ サブ分岐（分岐点から配線）</h4>
          <div class="sub-branches"></div>
          <button class="add-btn" onclick="addSubBranch(this)">＋ サブ分岐追加</button>
          
      </div>
    `;
    branchesDiv.appendChild(branchWrapper);
    updateBranchNumbers(branchesDiv, circuitIndex);
  }

  function removeBranch(btn) {
    const branchesDiv = btn.closest(".branches");
    const circuitIndex = Array.from(circuitsDiv.children).indexOf(btn.closest(".circuit")) + 1;
    btn.closest(".branch").remove();
    updateBranchNumbers(branchesDiv, circuitIndex);
  }

  function updateBranchNumbers(branchesDiv, circuitIndex) {
    branchesDiv.querySelectorAll(".branch").forEach((b, idx) => {
      b.querySelector("h3").innerHTML = `分岐 ${circuitIndex}-${idx + 1}
        <button class='remove-btn' onclick='removeBranch(this)'>分岐削除</button>`;
    });
  }

  // --- 3. サブ分岐（分岐点から配線）の追加/削除 ---
  function addSubBranch(btn) {
      const subBranchesDiv = btn.parentNode.querySelector(".sub-branches");
      const subBranchIndex = subBranchesDiv.children.length + 1;
      
      if (subBranchesDiv.children.length >= MAX_SUB_BRANCHES) {
        alert("サブ分岐は最大4つまでです。");
        return;
      }

      const subBranchWrapper = document.createElement("div");
      subBranchWrapper.className = "sub-branch";
      subBranchWrapper.style.marginLeft = "10px";
      subBranchWrapper.style.padding = "5px";
      subBranchWrapper.style.borderLeft = "3px solid #dc3545"; 
      subBranchWrapper.style.marginBottom = "10px";
      
      subBranchWrapper.innerHTML = `
        <h5 style="margin: 5px 0;">サブ分岐 ${subBranchIndex}
          <button class="remove-btn" onclick="removeSubBranch(this)" style="font-size: 10px; padding: 2px 4px;">削除</button>
        </h5>
        
        <p style="margin-left: 5px;">
          上位分岐点〜**下位分岐点**までのサブ幹線長さ(m)：
          <input type="number" class="len-to-sub-branch" min="0" step="0.1" value="0.0" style="width:50px;">
        </p>

        <div class="sub-lamps-container">
            <table>
                <thead>
                    <tr><th>番号</th><th>名称・記号</th><th>消費電力(W)</th><th>コード長(m)</th><th>操作</th></tr>
                </thead>
                <tbody class="sub-lamps-tbody"></tbody>
            </table>
            <button class="add-btn" onclick="addLampToSubBranch(this)" style="font-size: 10px; padding: 3px 6px;">＋ 照明追加</button>
        </div>
      `;
      subBranchesDiv.appendChild(subBranchWrapper);
  }

  function removeSubBranch(btn) {
    btn.closest(".sub-branch").remove();
  }

  // --- 4. 最上位分岐に直接接続される照明の追加/削除 ---
  function addLamp(btn) {
    const tbody = btn.closest(".branch-content").querySelector(".direct-lamps");
    const tr = createLampRow(tbody.children.length + 1, 'removeLamp(this)');
    tbody.appendChild(tr);
    updateLampNumbers(tbody);
  }

  function removeLamp(btn) {
    const tbody = btn.closest("tbody");
    btn.closest("tr").remove();
    updateLampNumbers(tbody);
  }

  // --- 5. サブ分岐に接続される照明の追加/削除 ---
  function addLampToSubBranch(btn) {
    const tbody = btn.closest(".sub-lamps-container").querySelector(".sub-lamps-tbody");
    // サブ分岐内の照明のコード長さは、「サブ分岐点以降の長さ」として扱われます
    const tr = createLampRow(tbody.children.length + 1, 'removeLampFromSubBranch(this)'); 
    tbody.appendChild(tr);
    updateLampNumbers(tbody);
  }

  function removeLampFromSubBranch(btn) {
    const tbody = btn.closest("tbody");
    btn.closest("tr").remove();
    updateLampNumbers(tbody);
  }

  // --- 共通の行作成ヘルパー ---
  function createLampRow(number, removeHandler) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${number}</td>
        <td><input type="text" class="name" style="width:100px;"></td>
        <td><input type="number" class="watt" min="0" step="0.1" value="0.0" style="width:50px;"></td>
        <td><input type="number" class="len" min="0" step="0.1" value="0.1" style="width:50px;"></td>
        <td><button class="remove-btn" onclick="${removeHandler}">削除</button></td>
      `;
      return tr;
  }

  // --- 共通の番号更新ヘルパー (変更なし) ---
  function updateLampNumbers(tbody) {
    tbody.querySelectorAll("tr").forEach((tr, i) => {
      tr.children[0].textContent = i + 1;
    });
  }

  // --- 6. 計算ロジック (calc) ---
  function calc() {
    const transformer = parseFloat(document.getElementById("transformer").value);
    const MAX_DROP = 2.0; // 許容電圧降下
    let totalW = 0;
    let lineResults = "";
    let overallResult = "<h2>計算結果</h2>";
    let overallWarning = "";

    const circuits = document.querySelectorAll(".circuit");

    circuits.forEach((c, cIdx) => {
      let circuitTotalW = 0;
      let circuitMaxDrop = 0; // このラインで最も大きい電圧降下値
      let circuitHtml = `<h3>ライン ${cIdx + 1}</h3>`;
      const branches = c.querySelectorAll(".branch");
      
      // ライン全体の合計W数を計算 (すべての照明W数を合算)
      branches.forEach(b => {
          b.querySelectorAll(".direct-lamps tr").forEach(r => {
              circuitTotalW += parseFloat(r.querySelector(".watt").value) || 0;
          });
          b.querySelectorAll(".sub-lamps-tbody tr").forEach(r => {
              circuitTotalW += parseFloat(r.querySelector(".watt").value) || 0;
          });
      });
      totalW += circuitTotalW;

      // 1. トランスから分岐点までの電圧降下 (e_trans)
      const lenToBranchInput = c.querySelector(".len-to-branch");
      const lenToBranch = parseFloat(lenToBranchInput.value) || 0;
      
      // ライン全体の合計Wで計算
      const dropE_trans = circuitTotalW * lenToBranch * DROP_PER_M; 
      
      circuitHtml += `<p>
        <b>ライン${cIdx + 1} 消費電力合計:</b> ${circuitTotalW.toFixed(1)} W<br>
        <b>トランス〜分岐点までの電圧降下 (e_trans):</b> ${circuitTotalW.toFixed(1)} W × ${lenToBranch.toFixed(1)} m × ${DROP_PER_M} V/W・m = <b>${dropE_trans.toFixed(3)} V</b>
      </p>`;

      branches.forEach((b, bIdx) => {
        let branchHtml = "";
        let branchMaxDrop = 0; // 最上位分岐点以降での最大電圧降下

        // --- 最大降下パスのための追跡変数 ---
        let maxE_main_val = 0; // この分岐におけるe_mainの最大値
        let maxE_sub_val = 0;  // この分岐におけるe_subの最大値


        // --- A. 接続照明の計算 (e_direct) ---
        let directW = 0; // 直接接続の合計W
        let directLen = 0; // 直接接続の合計Len
        const directLamps = b.querySelector(".direct-lamps").querySelectorAll("tr");
        let directLampRows = "";
        directLamps.forEach((r, idx) => {
          const w = parseFloat(r.querySelector(".watt").value) || 0;
          const len = parseFloat(r.querySelector(".len").value) || 0; 
          directW += w;
          directLen += len; 
          
          directLampRows += `
            <tr>
              <td>${idx + 1}</td>
              <td>${r.querySelector(".name").value || "-"}</td>
              <td>${w.toFixed(1)}</td>
              <td>${len.toFixed(1)}</td>
            </tr>`;
        });
        const dropE_direct = directW * directLen * DROP_PER_M; // e_direct

        // --- B. サブ分岐の計算 (e_main + e_sub) ---
        const subBranches = b.querySelectorAll(".sub-branch");
        let subBranchHtml = "";

        // この分岐内の全サブ分岐の合計Wを計算する (幹線に乗る総負荷)
        let totalSubBranchW = 0;
        subBranches.forEach(sb => {
            sb.querySelectorAll(".sub-lamps-tbody tr").forEach(r => {
                totalSubBranchW += parseFloat(r.querySelector(".watt").value) || 0;
            });
        });

        subBranches.forEach((sb, idx) => {
            const lenToSubBranch = parseFloat(sb.querySelector(".len-to-sub-branch").value) || 0; // 幹線長さ (L_main)
            
            let subBranchTotalW = 0; // このサブ分岐に接続される照明のW合計 (W_i)
            let subBranchTotalLen = 0; // このサブ分岐に接続される照明のコード長さ合計 (L_sub_i)
            let subLampRows = "";

            sb.querySelectorAll(".sub-lamps-tbody tr").forEach((r, lampIdx) => {
                const w = parseFloat(r.querySelector(".watt").value) || 0;
                const len = parseFloat(r.querySelector(".len").value) || 0;
                subBranchTotalW += w;
                subBranchTotalLen += len; 
                
                subLampRows += `
                    <tr>
                        <td>${lampIdx + 1}</td>
                        <td>${r.querySelector(".name").value || "-"}</td>
                        <td>${w.toFixed(1)}</td>
                        <td>${len.toFixed(1)}</td>
                    </tr>`;
            });

            // 2-1. 幹線電圧降下 (e_main) - 総サブ分岐W (totalSubBranchW) で計算
            const dropE_main = totalSubBranchW * lenToSubBranch * DROP_PER_M;
            if (dropE_main > maxE_main_val) {
                maxE_main_val = dropE_main; // 最大e_mainの更新
            }
            
            // 2-2. サブ分岐点以降の電圧降下 (e_sub) - 個別のサブ分岐W (subBranchTotalW) で計算
            const dropE_sub = subBranchTotalW * subBranchTotalLen * DROP_PER_M; 
            if (dropE_sub > maxE_sub_val) {
                maxE_sub_val = dropE_sub; // 最大e_subの更新
            }
            
            // 個別のサブ分岐の合計降下 (参考情報として表示)
            const dropTotal_Sub = dropE_main + dropE_sub;

            subBranchHtml += `
              <h5 style="margin-top: 10px; margin-left: 10px;">サブ分岐 ${idx + 1} の降下 ($e_{main} + e_{sub}$)</h5>
              
              <p style="margin-left: 10px; font-size: 13px;">
                **上位分岐点から流れる下位分岐W**: ${totalSubBranchW.toFixed(1)} W<br>
                **幹線長さ** ($L_{main}$): ${lenToSubBranch.toFixed(1)} m<br>
                **幹線降下 ($e_{main}$):** ${totalSubBranchW.toFixed(1)} W × ${lenToSubBranch.toFixed(1)} m × ${DROP_PER_M} V/W・m = **${dropE_main.toFixed(3)} V**
              </p>

              <table style="width: 95%; margin-left: 10px;">
                <thead><tr><th>番号</th><th>品名</th><th>消費電力(W)</th><th>コード長(m)</th></tr></thead>
                <tbody>${subLampRows}</tbody>
              </table>

              <p style="margin-left: 10px; font-size: 13px;">
                **このサブ分岐回路の負荷W**: ${subBranchTotalW.toFixed(1)} W<br>
                **サブ分岐点以降のコード長合計** ($L_{sub}$): ${subBranchTotalLen.toFixed(1)} m<br>
                **サブ分岐点以降の降下 ($e_{sub}$):** ${subBranchTotalW.toFixed(1)} W × ${subBranchTotalLen.toFixed(1)} m × ${DROP_PER_M} V/W・m = **${dropE_sub.toFixed(3)} V**<br>
                **サブ分岐の合計降下 ($e_{main} + e_{sub}$):** ${dropE_main.toFixed(3)} V + ${dropE_sub.toFixed(3)} V = **${dropTotal_Sub.toFixed(3)} V**
              </p>
            `;
        });
        
        // ★★★ V_BranchMaxの計算ロジック変更 (ご要望の反映) ★★★
        const maxSubPathDrop = maxE_main_val + maxE_sub_val; // 最大e_mainと最大e_subの合算 (架空の最大経路)
        
        // V_BranchMax (最上位分岐点以降の最大降下) の最終決定
        branchMaxDrop = Math.max(dropE_direct, maxSubPathDrop);

        // 最終電圧降下合計 = e_trans + V_BranchMax
        const finalTotalDrop = dropE_trans + branchMaxDrop;
        
        // ライン全体の最大降下を更新
        circuitMaxDrop = Math.max(circuitMaxDrop, finalTotalDrop);

        // 結果出力の表示形式を調整
        const dropClassFinal = finalTotalDrop > MAX_DROP ? "warning" : "";
        const branchDropName = `V_{BranchMax}`; // 最上位分岐点以降の最大降下

        // 最終的な合計の表示文字列を決定
        let finalSummation = "";
        let maxDropBreakdown = "";
        
        if (dropE_direct > maxSubPathDrop) {
            // 最大ドロップが直接接続経由の場合
            maxDropBreakdown = `${dropE_direct.toFixed(3)} V (e_{direct})`;
            finalSummation = `${dropE_trans.toFixed(3)} V (e_{trans}) + ${branchMaxDrop.toFixed(3)} V (${branchDropName})`;
        } else {
            // 最大ドロップがサブ分岐経由の最大経路の場合
            maxDropBreakdown = `${maxE_main_val.toFixed(3)} V (e_{main}) + ${maxE_sub_val.toFixed(3)} V (e_{sub})`;
            // 3項の合計として表示
            finalSummation = `${dropE_trans.toFixed(3)} V (e_{trans}) + ${maxE_main_val.toFixed(3)} V (e_{main}) + ${maxE_sub_val.toFixed(3)} V (e_{sub})`;
        }


        // 構造変更に合わせてHTML出力の順番も調整
        circuitHtml += `
          <h4>分岐 ${cIdx + 1}-${bIdx + 1}</h4>
          
          ${branchHtml}
          ${subBranchHtml}

          <p>
            <b>最上位分岐点以降最大電圧降下:</b> 
            <span class="${branchMaxDrop > MAX_DROP - dropE_trans ? "warning" : ""}">**${branchMaxDrop.toFixed(3)} V**</span> 
            (e_directと最大e_main+最大e_subの最大値)
            <br>
            *最大降下パス内訳*: ${maxDropBreakdown}
          </p>
          <p>
            **電圧降下合計 (トランス〜最終点):** ${finalSummation} = 
            <span class="${dropClassFinal}">**${finalTotalDrop.toFixed(3)} V**</span>
          </p>
          <hr>
        `;
      });
      
      // ライン全体の最大電圧降下
      const dropClassMax = circuitMaxDrop > MAX_DROP ? "warning" : "";
      circuitHtml += `
        <p>
          <b>ライン${cIdx + 1} 全体の最大電圧降下:</b> 
          <span class="${dropClassMax}">${circuitMaxDrop.toFixed(3)} V</span> 
          (許容 ${MAX_DROP} V)
        </p>
        <hr>
      `;

      if (circuitMaxDrop > MAX_DROP) {
        overallWarning += `<p class="warning">⚠ ライン ${cIdx + 1} が許容電圧降下（${MAX_DROP}V）を超えています！</p>`;
      }
      
      lineResults += circuitHtml;
    });

    overallResult += `<p><b>消費電力合計 (全ライン):</b> ${totalW.toFixed(1)} W</p>`;
    if (totalW > transformer) {
      overallWarning += `<p class="warning">⚠ トランス容量（${transformer}W）を超えています！</p>`;
    }

    document.getElementById("result").innerHTML = overallResult + overallWarning + lineResults;
  }

  // --- 7. 印刷処理 ---
  function preparePrint() {
    const project = document.getElementById("projectName").value || "未入力";
    const creator = document.getElementById("creator").value || "未入力";
    const transformer = document.getElementById("transformer").value;
    document.getElementById("printConditions").innerText =
      `トランス電圧：DC24V　|電源コード：9.5mmコード(3.5sq)　|　電圧降下量：0.00044V/W･m　|　許容電圧降下：2.0V　|　トランス容量：${transformer}W`;
    document.getElementById("printProjectInfo").innerText =
      `物件名：${project}　|　作成担当者：${creator}  |　作成日: ${new Date().toLocaleDateString()}`;
    window.print();
  }
</script>
</body>
</html>